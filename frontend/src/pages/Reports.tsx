import React, { useEffect, useState } from 'react';
import {
  Box,
  Typography,
  Paper,
  Grid,
  Card,
  CardContent,
  Chip,
  IconButton,
  Button,
  Stack,
  Avatar,
  LinearProgress,
  useTheme,
  alpha,
  Fade,
  Skeleton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions
} from '@mui/material';
import {
  TrendingUp,
  TrendingDown,
  Assessment,
  PieChart as PieChartIcon,
  BarChart as BarChartIcon,
  Timeline,
  Download,
  Refresh,
  FilterList,
  Insights,
  Analytics,
  Dashboard as DashboardIcon
} from '@mui/icons-material';
import { api } from '../services/api';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  Legend,
  Area,
  AreaChart
} from 'recharts';

interface MetricCardProps {
  title: string;
  value: string | number;
  change: number;
  icon: React.ReactNode;
  color: string;
}

const MetricCard: React.FC<MetricCardProps> = ({ title, value, change, icon, color }) => {
  const theme = useTheme();
  const isPositive = change >= 0;

  return (
    <Card
      sx={{
        height: '100%',
        background: `linear-gradient(135deg, ${alpha(color, 0.1)} 0%, ${alpha(color, 0.05)} 100%)`,
        border: `1px solid ${alpha(color, 0.2)}`,
        transition: 'all 0.3s ease',
        '&:hover': {
          transform: 'translateY(-4px)',
          boxShadow: `0 8px 25px ${alpha(color, 0.15)}`,
          border: `1px solid ${alpha(color, 0.3)}`
        }
      }}
    >
      <CardContent sx={{ p: 3 }}>
        <Stack direction="row" alignItems="center" justifyContent="space-between" mb={2}>
          <Avatar sx={{ bgcolor: color, width: 48, height: 48 }}>
            {icon}
          </Avatar>
          <Chip
            icon={isPositive ? <TrendingUp /> : <TrendingDown />}
            label={`${isPositive ? '+' : ''}${change}%`}
            size="small"
            sx={{
              bgcolor: isPositive ? alpha(theme.palette.success.main, 0.1) : alpha(theme.palette.error.main, 0.1),
              color: isPositive ? theme.palette.success.main : theme.palette.error.main,
              fontWeight: 600
            }}
          />
        </Stack>
        <Typography variant="h4" fontWeight={700} color={color} mb={0.5}>
          {value}
        </Typography>
        <Typography variant="body2" color="text.secondary" fontWeight={500}>
          <span data-translate>{title}</span>
        </Typography>
      </CardContent>
    </Card>
  );
};

const ChartCard: React.FC<{ title: string; children: React.ReactNode; actions?: React.ReactNode }> = ({
  title,
  children,
  actions
}) => {
  const theme = useTheme();

  return (
    <Card
      sx={{
        height: '100%',
        background: theme.palette.background.paper,
        border: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`,
        transition: 'all 0.3s ease',
        '&:hover': {
          boxShadow: `0 4px 20px ${alpha(theme.palette.primary.main, 0.1)}`
        }
      }}
    >
      <CardContent sx={{ p: 0 }}>
        <Stack
          direction="row"
          alignItems="center"
          justifyContent="space-between"
          sx={{ p: 3, pb: 2 }}
        >
          <Typography variant="h6" fontWeight={600} color="text.primary">
            <span data-translate>{title}</span>
          </Typography>
          {actions && (
            <Stack direction="row" spacing={1}>
              {actions}
            </Stack>
          )}
        </Stack>
        <Box sx={{ px: 3, pb: 3 }}>{children}</Box>
      </CardContent>
    </Card>
  );
};

const Reports: React.FC = () => {
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [reportDialog, setReportDialog] = useState(false);
  const [selectedReport, setSelectedReport] = useState<any>(null);
  const theme = useTheme();

  const handleViewReport = (report: any) => {
    setSelectedReport(report);
    setReportDialog(true);
  };

  const handleDownloadReport = (report: any) => {
    const reportContent = `${report.title}\n\nDate: ${report.date}\n\nSummary:\n${report.summary}\n\nMetrics: ${report.metrics}\n\nGenerated by FRA Atlas AI System\n${new Date().toLocaleString()}`;
    const blob = new Blob([reportContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${report.title.replace(/[^a-zA-Z0-9]/g, '_')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const res = await api.get('/fra/reports/summary');
        setData(res.data);
      } catch (error) {
        console.error('Error fetching reports data:', error);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  const COLORS = {
    primary: theme.palette.primary.main,
    secondary: theme.palette.secondary.main,
    success: theme.palette.success.main,
    warning: theme.palette.warning.main,
    error: theme.palette.error.main,
    info: theme.palette.info.main
  };

  const PIE_COLORS = [COLORS.primary, COLORS.secondary, COLORS.success, COLORS.warning, COLORS.info];

  if (loading) {
    return (
      <Box>
        <Skeleton variant="text" width={300} height={48} sx={{ mb: 3 }} />
        <Grid container spacing={3}>
          {[1, 2, 3, 4].map((i) => (
            <Grid item xs={12} sm={6} md={3} key={i}>
              <Skeleton variant="rectangular" height={140} sx={{ borderRadius: 1 }} />
            </Grid>
          ))}
          <Grid item xs={12}>
            <Skeleton variant="rectangular" height={400} sx={{ borderRadius: 1 }} />
          </Grid>
        </Grid>
      </Box>
    );
  }

  if (!data) {
    return (
      <Box display="flex" alignItems="center" justifyContent="center" minHeight={400}>
        <Typography variant="h6" color="text.secondary">
          <span data-translate>No data available</span>
        </Typography>
      </Box>
    );
  }

  return (
    <Fade in timeout={800}>
      <Box>
        {/* Header */}
        <Stack
          direction={{ xs: 'column', sm: 'row' }}
          alignItems={{ xs: 'flex-start', sm: 'center' }}
          justifyContent="space-between"
          mb={4}
        >
          <Box>
            <Typography
              variant="h3"
              fontWeight={700}
              color="primary.main"
              sx={{ mb: 1 }}
            >
              <span data-translate>Reports & Analytics</span>
            </Typography>
            <Typography variant="body1" color="text.secondary" fontWeight={500}>
              <span data-translate>Comprehensive insights and performance metrics</span>
            </Typography>
          </Box>
          <Stack direction="row" spacing={2}>
            <Button
              variant="outlined"
              startIcon={<FilterList />}
              sx={{ borderRadius: 2 }}
            >
              <span data-translate>Filters</span>
            </Button>
            <Button
              variant="outlined"
              startIcon={<Download />}
              sx={{ borderRadius: 2 }}
            >
              <span data-translate>Export</span>
            </Button>
            <IconButton
              sx={{
                bgcolor: alpha(theme.palette.primary.main, 0.1),
                '&:hover': { bgcolor: alpha(theme.palette.primary.main, 0.2) }
              }}
            >
              <Refresh />
            </IconButton>
          </Stack>
        </Stack>

        {/* AI Generated Reports Section */}
        <Grid container spacing={3} mb={4}>
          <Grid item xs={12}>
            <Card sx={{ mb: 3 }}>
              <CardContent sx={{ p: 3 }}>
                <Typography variant="h5" fontWeight={600} mb={3} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                  <Assessment sx={{ color: COLORS.primary }} />
                  AI-Generated Reports
                </Typography>
                
                <Grid container spacing={3}>
                  {/* Weekly Reports */}
                  <Grid item xs={12} md={6}>
                    <Paper sx={{ p: 3, border: `1px solid ${alpha(COLORS.success, 0.2)}`, bgcolor: alpha(COLORS.success, 0.05) }}>
                      <Typography variant="h6" fontWeight={600} mb={2} color={COLORS.success} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Timeline sx={{ fontSize: 20 }} />
                        Weekly Reports
                      </Typography>
                      
                      <Stack spacing={2}>
                        {[
                          {
                            title: "Weekly FRA Implementation Report - Week 52, 2024",
                            date: "Dec 23-29, 2024",
                            summary: "Comprehensive analysis of 1,247 new claims processed, 89% approval rate, covering 15 districts across 4 states. Key insights on tribal land rights progress.",
                            metrics: "1,247 Claims | 89% Approval | 15 Districts"
                          },
                          {
                            title: "Weekly Performance Analytics - Week 51, 2024", 
                            date: "Dec 16-22, 2024",
                            summary: "Detailed performance metrics showing 12% increase in processing efficiency, improved data quality scores, and enhanced user satisfaction ratings.",
                            metrics: "12% Efficiency â†‘ | 94% Quality | 91% Satisfaction"
                          },
                          {
                            title: "Weekly Compliance & Audit Report - Week 50, 2024",
                            date: "Dec 9-15, 2024", 
                            summary: "Compliance assessment covering regulatory adherence, audit findings, risk mitigation strategies, and recommendations for process improvements.",
                            metrics: "98% Compliance | 3 Audit Items | 5 Recommendations"
                          }
                        ].map((report, index) => (
                          <Card key={index} sx={{ p: 2, border: '1px solid #e0e0e0' }}>
                            <Typography variant="subtitle1" fontWeight={600} gutterBottom>
                              {report.title}
                            </Typography>
                            <Typography variant="caption" color="text.secondary" display="block" mb={1}>
                              {report.date}
                            </Typography>
                            <Typography variant="body2" color="text.secondary" mb={2}>
                              {report.summary}
                            </Typography>
                            <Chip label={report.metrics} size="small" sx={{ mb: 2 }} />
                            <Stack direction="row" spacing={1}>
                              <Button size="small" variant="outlined" startIcon={<Assessment />} onClick={() => handleViewReport(report)}>
                                View Report
                              </Button>
                              <Button size="small" variant="text" startIcon={<Download />} onClick={() => handleDownloadReport(report)}>
                                Download PDF
                              </Button>
                            </Stack>
                          </Card>
                        ))}
                      </Stack>
                    </Paper>
                  </Grid>

                  {/* Monthly Reports */}
                  <Grid item xs={12} md={6}>
                    <Paper sx={{ p: 3, border: `1px solid ${alpha(COLORS.primary, 0.2)}`, bgcolor: alpha(COLORS.primary, 0.05) }}>
                      <Typography variant="h6" fontWeight={600} mb={2} color={COLORS.primary} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <BarChartIcon sx={{ fontSize: 20 }} />
                        Monthly Reports
                      </Typography>
                      
                      <Stack spacing={2}>
                        {[
                          {
                            title: "Monthly FRA Progress Report - December 2024",
                            date: "December 2024",
                            summary: "Comprehensive monthly analysis covering 5,847 claims processed, state-wise performance metrics, beneficiary demographics, and implementation challenges across all regions.",
                            metrics: "5,847 Claims | 23 States | 156 Districts | 2,341 Villages"
                          },
                          {
                            title: "Monthly Strategic Analysis - November 2024",
                            date: "November 2024", 
                            summary: "Strategic insights on policy implementation effectiveness, resource allocation optimization, stakeholder engagement metrics, and recommendations for next quarter.",
                            metrics: "87% Policy Adherence | 15% Resource Optimization | 92% Stakeholder Satisfaction"
                          },
                          {
                            title: "Monthly Impact Assessment - October 2024",
                            date: "October 2024",
                            summary: "Detailed impact assessment covering socio-economic benefits, environmental conservation outcomes, livelihood improvements, and long-term sustainability metrics.",
                            metrics: "12,450 Beneficiaries | 8,750 Hectares | 45% Livelihood Improvement"
                          }
                        ].map((report, index) => (
                          <Card key={index} sx={{ p: 2, border: '1px solid #e0e0e0' }}>
                            <Typography variant="subtitle1" fontWeight={600} gutterBottom>
                              {report.title}
                            </Typography>
                            <Typography variant="caption" color="text.secondary" display="block" mb={1}>
                              {report.date}
                            </Typography>
                            <Typography variant="body2" color="text.secondary" mb={2}>
                              {report.summary}
                            </Typography>
                            <Chip label={report.metrics} size="small" sx={{ mb: 2 }} />
                            <Stack direction="row" spacing={1}>
                              <Button size="small" variant="outlined" startIcon={<Assessment />} onClick={() => handleViewReport(report)}>
                                View Report
                              </Button>
                              <Button size="small" variant="text" startIcon={<Download />} onClick={() => handleDownloadReport(report)}>
                                Download PDF
                              </Button>
                            </Stack>
                          </Card>
                        ))}
                      </Stack>
                    </Paper>
                  </Grid>
                </Grid>

                {/* Report Generation Actions */}
                <Box sx={{ mt: 3, p: 2, bgcolor: alpha(COLORS.info, 0.05), borderRadius: 2, border: `1px solid ${alpha(COLORS.info, 0.2)}` }}>
                  <Typography variant="h6" fontWeight={600} mb={2} color={COLORS.info} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Insights sx={{ fontSize: 20 }} />
                    AI Report Generation
                  </Typography>
                  <Typography variant="body2" color="text.secondary" mb={2}>
                    Generate comprehensive reports using AI analysis of all system data including claims, beneficiaries, performance metrics, and compliance indicators.
                  </Typography>
                  <Stack direction="row" spacing={2}>
                    <Button variant="contained" startIcon={<Analytics />}>
                      Generate Weekly Report
                    </Button>
                    <Button variant="outlined" startIcon={<Assessment />}>
                      Generate Monthly Report
                    </Button>
                    <Button variant="text" startIcon={<Download />}>
                      Download All Reports
                    </Button>
                  </Stack>
                </Box>
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        {/* Analytics Section Header */}
        <Typography variant="h5" fontWeight={600} mb={3} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          <Analytics sx={{ color: COLORS.secondary }} />
          Analytics Dashboard
        </Typography>

        {/* Metrics Cards */}
        <Grid container spacing={3} mb={4}>
          <Grid item xs={12} sm={6} md={3}>
            <MetricCard
              title="Total Beneficiaries"
              value="12,847"
              change={12.5}
              icon={<Assessment />}
              color={COLORS.primary}
            />
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <MetricCard
              title="Active Claims"
              value="3,256"
              change={8.2}
              icon={<DashboardIcon />}
              color={COLORS.success}
            />
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <MetricCard
              title="Processed This Month"
              value="1,847"
              change={-2.1}
              icon={<Timeline />}
              color={COLORS.warning}
            />
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <MetricCard
              title="Success Rate"
              value="94.2%"
              change={5.7}
              icon={<Insights />}
              color={COLORS.info}
            />
          </Grid>
        </Grid>

        {/* Charts */}
        <Grid container spacing={3}>
          {/* Beneficiaries Trend */}
          <Grid item xs={12}>
            <ChartCard
              title="Beneficiaries Growth Trend"
              actions={
                <>
                  <IconButton size="small">
                    <BarChartIcon />
                  </IconButton>
                  <IconButton size="small">
                    <Timeline />
                  </IconButton>
                </>
              }
            >
              <ResponsiveContainer width="100%" height={350}>
                <AreaChart data={data.timeseries}>
                  <defs>
                    <linearGradient id="colorBeneficiaries" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor={COLORS.primary} stopOpacity={0.3} />
                      <stop offset="95%" stopColor={COLORS.primary} stopOpacity={0.05} />
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke={alpha(theme.palette.divider, 0.3)} />
                  <XAxis
                    dataKey="month"
                    axisLine={false}
                    tickLine={false}
                    tick={{ fontSize: 12, fill: theme.palette.text.secondary }}
                  />
                  <YAxis
                    axisLine={false}
                    tickLine={false}
                    tick={{ fontSize: 12, fill: theme.palette.text.secondary }}
                  />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: theme.palette.background.paper,
                      border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
                      borderRadius: 8,
                      boxShadow: `0 4px 20px ${alpha(theme.palette.common.black, 0.1)}`
                    }}
                  />
                  <Area
                    type="monotone"
                    dataKey="beneficiaries"
                    stroke={COLORS.primary}
                    strokeWidth={3}
                    fill="url(#colorBeneficiaries)"
                  />
                </AreaChart>
              </ResponsiveContainer>
            </ChartCard>
          </Grid>

          {/* Distribution Charts */}
          <Grid item xs={12} md={6}>
            <ChartCard
              title="Claims by Type"
              actions={
                <IconButton size="small">
                  <PieChartIcon />
                </IconButton>
              }
            >
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    dataKey="value"
                    data={data.byType}
                    nameKey="type"
                    cx="50%"
                    cy="50%"
                    outerRadius={100}
                    innerRadius={40}
                    paddingAngle={2}
                    label={({ percent }) => `${(percent * 100).toFixed(0)}%`}
                  >
                    {data.byType.map((_: any, idx: number) => (
                      <Cell key={idx} fill={PIE_COLORS[idx % PIE_COLORS.length]} />
                    ))}
                  </Pie>
                  <Legend
                    wrapperStyle={{
                      paddingTop: '20px',
                      fontSize: '14px'
                    }}
                  />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: theme.palette.background.paper,
                      border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
                      borderRadius: 8
                    }}
                  />
                </PieChart>
              </ResponsiveContainer>
            </ChartCard>
          </Grid>

          {/* Top Districts */}
          <Grid item xs={12} md={6}>
            <ChartCard
              title="Top Performing Districts"
              actions={
                <IconButton size="small">
                  <BarChartIcon />
                </IconButton>
              }
            >
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={data.topDistricts} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke={alpha(theme.palette.divider, 0.3)} />
                  <XAxis
                    dataKey="name"
                    axisLine={false}
                    tickLine={false}
                    tick={{ fontSize: 12, fill: theme.palette.text.secondary }}
                    angle={-45}
                    textAnchor="end"
                    height={80}
                  />
                  <YAxis
                    axisLine={false}
                    tickLine={false}
                    tick={{ fontSize: 12, fill: theme.palette.text.secondary }}
                  />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: theme.palette.background.paper,
                      border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`,
                      borderRadius: 8
                    }}
                  />
                  <Bar
                    dataKey="beneficiaries"
                    fill={COLORS.secondary}
                    radius={[4, 4, 0, 0]}
                  />
                </BarChart>
              </ResponsiveContainer>
            </ChartCard>
          </Grid>



          {/* Performance Indicators */}
          <Grid item xs={12}>
            <Card
              sx={{
                background: `linear-gradient(135deg, ${alpha(COLORS.primary, 0.05)} 0%, ${alpha(COLORS.secondary, 0.05)} 100%)`,
                border: `1px solid ${alpha(COLORS.primary, 0.1)}`
              }}
            >
              <CardContent sx={{ p: 3 }}>
                <Typography variant="h6" fontWeight={600} mb={3}>
                  <span data-translate>Key Performance Indicators</span>
                </Typography>
                <Grid container spacing={3}>
                  <Grid item xs={12} sm={6} md={3}>
                    <Box>
                      <Typography variant="body2" color="text.secondary" mb={1}>
                        <span data-translate>Processing Efficiency</span>
                      </Typography>
                      <LinearProgress
                        variant="determinate"
                        value={87}
                        sx={{
                          height: 8,
                          borderRadius: 4,
                          bgcolor: alpha(COLORS.primary, 0.1),
                          '& .MuiLinearProgress-bar': {
                            borderRadius: 4,
                            bgcolor: COLORS.primary
                          }
                        }}
                      />
                      <Typography variant="body2" fontWeight={600} mt={1}>
                        87%
                      </Typography>
                    </Box>
                  </Grid>
                  <Grid item xs={12} sm={6} md={3}>
                    <Box>
                      <Typography variant="body2" color="text.secondary" mb={1}>
                        <span data-translate>Data Quality</span>
                      </Typography>
                      <LinearProgress
                        variant="determinate"
                        value={94}
                        sx={{
                          height: 8,
                          borderRadius: 4,
                          bgcolor: alpha(COLORS.success, 0.1),
                          '& .MuiLinearProgress-bar': {
                            borderRadius: 4,
                            bgcolor: COLORS.success
                          }
                        }}
                      />
                      <Typography variant="body2" fontWeight={600} mt={1}>
                        94%
                      </Typography>
                    </Box>
                  </Grid>
                  <Grid item xs={12} sm={6} md={3}>
                    <Box>
                      <Typography variant="body2" color="text.secondary" mb={1}>
                        <span data-translate>User Satisfaction</span>
                      </Typography>
                      <LinearProgress
                        variant="determinate"
                        value={91}
                        sx={{
                          height: 8,
                          borderRadius: 4,
                          bgcolor: alpha(COLORS.info, 0.1),
                          '& .MuiLinearProgress-bar': {
                            borderRadius: 4,
                            bgcolor: COLORS.info
                          }
                        }}
                      />
                      <Typography variant="body2" fontWeight={600} mt={1}>
                        91%
                      </Typography>
                    </Box>
                  </Grid>
                  <Grid item xs={12} sm={6} md={3}>
                    <Box>
                      <Typography variant="body2" color="text.secondary" mb={1}>
                        <span data-translate>System Uptime</span>
                      </Typography>
                      <LinearProgress
                        variant="determinate"
                        value={99}
                        sx={{
                          height: 8,
                          borderRadius: 4,
                          bgcolor: alpha(COLORS.warning, 0.1),
                          '& .MuiLinearProgress-bar': {
                            borderRadius: 4,
                            bgcolor: COLORS.warning
                          }
                        }}
                      />
                      <Typography variant="body2" fontWeight={600} mt={1}>
                        99.2%
                      </Typography>
                    </Box>
                  </Grid>
                </Grid>
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        <Dialog open={reportDialog} onClose={() => setReportDialog(false)} maxWidth="md" fullWidth>
          <DialogTitle>{selectedReport?.title}</DialogTitle>
          <DialogContent>
            {selectedReport && (
              <Box>
                <Typography variant="body2" gutterBottom><strong>Date:</strong> {selectedReport.date}</Typography>
                <Typography variant="body2" gutterBottom><strong>Metrics:</strong> {selectedReport.metrics}</Typography>
                <Typography variant="h6" sx={{ mt: 2, mb: 1 }}>Summary</Typography>
                <Typography variant="body1">{selectedReport.summary}</Typography>
              </Box>
            )}
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setReportDialog(false)}>Close</Button>
            <Button variant="contained" startIcon={<Download />} onClick={() => selectedReport && handleDownloadReport(selectedReport)}>Download</Button>
          </DialogActions>
        </Dialog>
      </Box>
    </Fade>
  );
};

export default Reports;



